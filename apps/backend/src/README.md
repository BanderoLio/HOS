# HOS (Hospital Organization System) - MVP ТЗ

## Общее описание

**HOS** — система управления поликлиникой для российского рынка. Один инстанс приложения = одна поликлиника. Приложение предназначено для автоматизации работы медицинского учреждения: учет пациентов и врачей, организация записи на прием, ведение истории болезней, выписка рецептов.

## Технический стек

### Backend

- **Framework**: NestJS (2025)
- **Language**: TypeScript (strict mode)
- **ORM**: Prisma
- **Database**: PostgreSQL
- **Authentication**: JWT (Access + Refresh tokens)
- **Caching**: Redis
- **API Documentation**: Swagger/OpenAPI + ReDoc
- **Validation**: class-validator + class-transformer
- **Rate Limits**: Rate limits for API

### Frontend

- **Framework**: React 18+
- **Language**: TypeScript
- **Styling**: TailwindCSS + shadcn/ui
- **State Management**: React Query / Zustand
- **Routing**: React Router
- **Build Tool**: Vite
- **Design System**: Минималистичный дизайн: большие кнопки, чистая типографика, использование темы

### Инфраструктура

- **Monorepo**: Turborepo + pnpm workspaces
- **Code Quality**: ESLint, Prettier
- **Type Safety**: Строгая типизация, shared types между frontend и backend

## Архитектурные принципы

### Backend (NestJS)

- ✅ **Модульность**: Каждый домен — отдельный модуль
- ✅ **SOLID**: Single Responsibility, Dependency Inversion
- ✅ **Separation of Concerns**: Четкое разделение слоев (Controller → Service → Repository)
- ✅ **DRY**: Переиспользование кода через общие сервисы и утилиты
- ✅ **Type Safety**: Строгая типизация, использование Prisma типов
- ✅ **Error Handling**: Централизованная обработка ошибок через фильтры
- ✅ **Validation**: DTO с class-validator на всех входных точках
- ✅ **Audit**: Автоматическое логирование изменений в БД

### Frontend (React)

- ✅ **Component Composition**: Переиспользование компонентов
- ✅ **Separation of Concerns**: Разделение логики и представления
- ✅ **Type Safety**: Строгая типизация с shared types
- ✅ **Accessibility**: Соответствие WCAG стандартам
- ✅ **Performance**: Оптимизация рендеринга, lazy loading

## Структура базы данных

### Основные сущности

#### 1. **User** (Пользователь)

Базовые данные физического лица:

- `id_user` (PK)
- `lname` (Фамилия) — обязательное
- `name` (Имя) — обязательное
- `mname` (Отчество) — опционально
- `gender` (Пол: 'm' | 'w')
- `birth_date` (Дата рождения)
- `created_at` (Дата создания)

**Связанные сущности:**

- `UserContact[]` — контакты (телефон, email)
- `Account` — учетная запись для входа
- `Patient` или `Doctor` — роль в системе

#### 2. **Account** (Учетная запись)

Учетные данные для авторизации:

- `id_account` (PK, UUID)
- `id_user` (FK → User)
- `username` (Уникальный логин)
- `password` (Хэшированный пароль)
- `roles[]` — роли пользователя

#### 3. **Patient** (Пациент)

Данные пациента:

- `id_patient` (PK)
- `id_user` (FK → User, уникальный)
- `id_passport` (FK → Passport, опционально, уникальный)
- `id_address` (FK → Address, опционально)
- `insurance_policy` (Страховой полис, уникальный)
- `registration_date` (Дата регистрации)

**Связанные сущности:**

- `Appointment[]` — записи на прием
- `Passport` — паспортные данные
- `Address` — адрес проживания

#### 4. **Doctor** (Врач)

Данные врача:

- `id_doctor` (PK)
- `id_user` (FK → User, уникальный)
- `license_number` (Номер лицензии, уникальный)
- `experience_years` (Опыт работы в годах, >= 0)
- `hire_date` (Дата найма)

**Связанные сущности:**

- `DoctorSpecialization[]` — специализации врача
- `Schedule[]` — расписание работы
- `ScheduleTemplate[]` — шаблоны расписания
- `Appointment[]` — записи на прием

#### 5. **Specialization** (Специализация)

Справочник специализаций:

- `id_spec` (PK)
- `name` (Название, уникальное)
- `description` (Описание)

**Примеры**: "Терапевт", "Кардиолог", "Невролог", "Педиатр" и т.д.

#### 6. **ScheduleTemplate** (Шаблон расписания)

Шаблонное расписание врача по дням недели:

- `id_template` (PK)
- `id_doctor` (FK → Doctor)
- `day_of_week` (День недели: 'monday'...'sunday')
- `start_time` (Время начала приема)
- `end_time` (Время окончания приема, > start_time)
- `id_room` (FK → Room, опционально)
- `slot_duration` (Длительность слота в минутах, по умолчанию 15)
- `effective_from` (Дата начала действия)
- `effective_to` (Дата окончания действия, опционально)

**Особенности:**

- Исключающее ограничение (EXCLUDE) предотвращает наложение расписаний одного врача в один день недели
- Автоматическое закрытие предыдущих шаблонов при создании нового

#### 7. **Schedule** (Конкретное расписание)

Расписание врача на конкретную дату (переопределяет шаблон):

- `id_schedule` (PK)
- `id_doctor` (FK → Doctor)
- `work_date` (Дата работы)
- `start_time` (Время начала)
- `end_time` (Время окончания, > start_time)
- `id_room` (FK → Room, опционально)
- `slot_duration` (Длительность слота в минутах)
- `is_available` (Доступно для записи, по умолчанию true)
- `notes` (Заметки)

**Особенности:**

- Исключающее ограничение предотвращает наложение расписаний одного врача в один день
- При создании расписания автоматически отменяются пересекающиеся записи

#### 8. **Room** (Кабинет)

Кабинеты поликлиники:

- `id_room` (PK)
- `room_number` (Номер кабинета, уникальный)
- `floor` (Этаж)
- `description` (Описание)

#### 9. **Appointment** (Запись на прием)

Запись пациента к врачу:

- `id_appointment` (PK)
- `id_patient` (FK → Patient)
- `id_doctor` (FK → Doctor)
- `appointment_time` (Время приема, TIMESTAMP)
- `duration` (Длительность в минутах, по умолчанию 15, > 0)
- `status` (Статус: 'scheduled' | 'completed' | 'cancelled' | 'no_show')
- `complaints` (Жалобы пациента, текст)
- `created_at` (Дата создания)
- `updated_at` (Дата обновления, автоматически)

**Особенности:**

- Исключающее ограничение предотвращает наложение записей одного врача (кроме отмененных)
- Автоматическое обновление `updated_at` при изменении

#### 10. **DiagnosisDirectory** (Справочник диагнозов)

Справочник диагнозов (МКБ-10):

- `id_diagnosis` (PK)
- `code` (Код МКБ-10, уникальный)
- `name` (Название диагноза)
- `description` (Описание)

#### 11. **PatientDiagnosis** (Диагноз пациента)

Диагноз, поставленный пациенту на приеме:

- `id_patient_diagnosis` (PK)
- `id_appointment` (FK → Appointment)
- `id_diagnosis` (FK → DiagnosisDirectory, опционально)
- `diagnosis_text` (Текст диагноза, обязательное)
- `is_primary` (Первичный диагноз, по умолчанию true)
- `diagnosis_date` (Дата постановки диагноза)
- `notes` (Заметки)

**Особенности:**

- Один первичный диагноз на прием (частичный уникальный индекс)

#### 12. **Medication** (Справочник лекарств)

Справочник лекарственных препаратов:

- `id_medication` (PK)
- `name` (Название, уникальное)
- `active_substance` (Действующее вещество)
- `form` (Форма выпуска)
- `dosage` (Дозировка)

#### 13. **Prescription** (Рецепт/Назначение)

Назначение лекарства пациенту:

- `id_prescription` (PK)
- `id_appointment` (FK → Appointment)
- `id_medication` (FK → Medication, опционально)
- `custom_medication_name` (Кастомное название лекарства, опционально)
- `dosage` (Дозировка, обязательное)
- `frequency` (Частота приема, обязательное)
- `duration` (Длительность приема)
- `instructions` (Инструкции по применению)
- `prescription_date` (Дата выписки)
- `is_issued` (Выдан ли рецепт, по умолчанию false)

**Особенности:**

- Либо `id_medication`, либо `custom_medication_name` должно быть заполнено (CHECK constraint)

#### 14. **Passport** (Паспорт)

Паспортные данные:

- `id_passport` (PK)
- `series` (Серия, 1-9999)
- `number` (Номер, 1-1000000)
- `issued_by` (Кем выдан)
- `issue_date` (Дата выдачи, <= текущей даты)

**Особенности:**

- Уникальная комбинация series + number

#### 15. **Address** (Адрес)

Адрес проживания:

- `id_address` (PK)
- `country` (Страна, по умолчанию 'Россия')
- `region` (Регион)
- `city` (Город, обязательное)
- `street` (Улица)
- `house` (Дом)
- `apartment` (Квартира)
- `postal_code` (Почтовый индекс)

#### 16. **UserContact** (Контакт)

Контактная информация пользователя:

- `id_contact` (PK)
- `id_user` (FK → User)
- `phone` (Телефон, формат: +7XXXXXXXXXX)
- `email` (Email, валидный формат)
- `is_primary` (Основной контакт, по умолчанию false)

**Особенности:**

- Хотя бы один из phone или email должен быть заполнен
- Один основной контакт на пользователя (частичный уникальный индекс)
- Уникальные комбинации id_user + phone и id_user + email

#### 17. **AUDIT_DELTA_HIST** (Аудит изменений)

Автоматический аудит всех изменений в БД:

- `audit_id` (PK)
- `table_name` (Имя таблицы)
- `pk_data` (JSONB с первичным ключом)
- `column_name` (Имя измененного столбца)
- `old_value` (Старое значение)
- `new_value` (Новое значение)
- `operation` ('INSERT' | 'UPDATE' | 'DELETE')
- `changed_at` (Время изменения)

**Особенности:**

- Автоматическое логирование через триггеры на таблицах: User, UserContact, Passport, Doctor, Patient

### Представления (Views)

#### 1. **V_DOCTOR_STATISTICS**

Статистика по врачам:

- Общее количество приемов
- Приемы по статусам (completed, cancelled, no_show, scheduled)
- Статистика за последние 30 дней
- Статистика за текущий месяц
- Количество уникальных пациентов
- Список специализаций

#### 2. **V_DAILY_APPOINTMENTS**

Детальный отчет по приемам:

- Информация о приеме (дата, время, статус, длительность, жалобы)
- Информация о враче (ФИО, специализации, кабинет)
- Информация о пациенте (ФИО, возраст, контакты)
- Диагнозы
- Количество назначений
- Время создания и обновления

#### 3. **TEMPLATE_SLOTS**

Вычисляемые слоты из шаблонов расписания:

- Разбивает временные интервалы на слоты по `slot_duration`
- Используется для поиска свободных окон

#### 4. **SPECIFIC_SLOTS**

Вычисляемые слоты из конкретного расписания:

- Разбивает временные интервалы на слоты
- Только для доступных расписаний (`is_available = true`)

### Функции и процедуры

#### Функции работы с днями недели:

- `DOW_FROM_DATE(date)` — день недели из даты
- `DOW_TO_NUM(dow)` — номер дня недели
- `DOW_TO_DATE(day, date_on_week)` — дата конкретного дня недели

#### Функции работы со слотами:

- `DOCTOR_SLOTS_FOR_DATE(doctor_id, date)` — свободные слоты врача на дату
- `DOCTOR_SLOTS_FOR_PERIOD(doctor_id, from_date, period)` — свободные слоты за период
- `GET_WEEK_SCHEDULE(date)` — расписание на неделю (шаблоны + конкретные)

#### Процедуры:

- `CLEAR_NO_SHOW(from_now)` — очистка старых записей со статусом 'no_show'
- `NO_SHOW_OLD(from_now)` — пометка старых записей как 'no_show'
- `COMPLETE_APPOINTMENT(appointment_id, diagnosis_text, ...)` — завершение приема с постановкой диагноза

### Триггеры

1. **ON_NEW_SCHEDULE_TR** — при создании расписания автоматически отменяет пересекающиеся записи
2. **close_open_ended_template_tr** — автоматически закрывает предыдущие шаблоны при создании нового
3. **UPDATE_APPOINTMENT_UPDATED_AT** — автоматически обновляет `updated_at` в Appointment
4. **AUDIT_DELTA_F** — аудит изменений в User, UserContact, Passport, Doctor, Patient

## Функциональные требования MVP

### 1. Аутентификация и авторизация

#### Роли пользователей:

- **Администратор** — полный доступ
- **Врач** — доступ к своему расписанию, приемам, истории пациентов
- **Регистратор** — создание записей, просмотр расписания
- **Пациент** — просмотр своих записей, истории

#### Эндпоинты:

- `POST /auth/login` — вход (username + password)
- `POST /auth/signup` — регистрация (только для администратора)
- `POST /auth/logout` — выход
- `POST /auth/refresh` — обновление токена

**Безопасность:**

- JWT Access Token (короткоживущий, в Authorization header)
- JWT Refresh Token (долгоживущий, в httpOnly cookie)
- Refresh token blacklist в Redis
- Хэширование паролей (bcrypt)

### 2. Управление пользователями

#### Пациенты:

- `GET /patients` — список пациентов (пагинация, фильтры)
- `GET /patients/:id` — детали пациента
- `POST /patients` — создание пациента
- `PATCH /patients/:id` — обновление данных
- `GET /patients/:id/appointments` — история приемов пациента
- `GET /patients/:id/diagnoses` — история диагнозов

#### Врачи:

- `GET /doctors` — список врачей (с фильтром по специализации)
- `GET /doctors/:id` — детали врача
- `POST /doctors` — создание врача (только администратор)
- `PATCH /doctors/:id` — обновление данных
- `GET /doctors/:id/statistics` — статистика врача
- `GET /doctors/:id/specializations` — специализации врача

#### Специализации:

- `GET /specializations` — список специализаций
- `POST /specializations` — создание (только администратор)

### 3. Расписание

#### Шаблоны расписания:

- `GET /doctors/:id/schedule-templates` — шаблоны врача
- `POST /doctors/:id/schedule-templates` — создание шаблона
- `PATCH /schedule-templates/:id` — обновление шаблона
- `DELETE /schedule-templates/:id` — удаление шаблона

#### Конкретное расписание:

- `GET /doctors/:id/schedule?date=YYYY-MM-DD` — расписание на дату
- `GET /doctors/:id/schedule/week?date=YYYY-MM-DD` — расписание на неделю
- `POST /doctors/:id/schedule` — создание расписания на дату
- `PATCH /schedule/:id` — обновление расписания
- `DELETE /schedule/:id` — удаление расписания

#### Свободные окна:

- `GET /doctors/:id/available-slots?date=YYYY-MM-DD` — свободные слоты на дату
- `GET /doctors/:id/available-slots?from=YYYY-MM-DD&period=7 days` — свободные слоты за период

**Ключевой запрос MVP:** "Свободные окна у врача Иванова на завтра"

### 4. Записи на прием

#### Эндпоинты:

- `GET /appointments` — список записей (фильтры: doctor, patient, date, status)
- `GET /appointments/:id` — детали записи
- `POST /appointments` — создание записи
- `PATCH /appointments/:id` — обновление записи (статус, жалобы)
- `DELETE /appointments/:id` — отмена записи
- `POST /appointments/:id/complete` — завершение приема (с диагнозом)

**Бизнес-логика:**

- Проверка на наложение по времени (через EXCLUDE constraint)
- Автоматическая отмена при создании пересекающегося расписания
- Валидация: слот должен быть свободен, врач доступен

**Ключевой запрос MVP:** "Все пациенты, записанные к терапевту"

### 5. Диагнозы

#### Справочник диагнозов:

- `GET /diagnoses` — список диагнозов (поиск по коду/названию)
- `POST /diagnoses` — добавление диагноза (только администратор)

#### Диагнозы пациента:

- `GET /appointments/:id/diagnoses` — диагнозы по приему
- `POST /appointments/:id/diagnoses` — добавление диагноза
- `PATCH /diagnoses/:id` — обновление диагноза

### 6. Рецепты/Назначения

#### Эндпоинты:

- `GET /appointments/:id/prescriptions` — назначения по приему
- `POST /appointments/:id/prescriptions` — создание назначения
- `PATCH /prescriptions/:id` — обновление назначения
- `POST /prescriptions/:id/issue` — отметка о выдаче рецепта

#### Справочник лекарств:

- `GET /medications` — список лекарств (поиск)
- `POST /medications` — добавление лекарства (только администратор)

### 7. Кабинеты

- `GET /rooms` — список кабинетов
- `POST /rooms` — создание кабинета (только администратор)
- `PATCH /rooms/:id` — обновление кабинета

### 8. Отчеты и статистика

- `GET /doctors/:id/statistics` — статистика врача (использует V_DOCTOR_STATISTICS)
- `GET /appointments/daily?date=YYYY-MM-DD` — отчет по приемам за день (использует V_DAILY_APPOINTMENTS)

## API Спецификация

### Формат запросов/ответов

#### Успешный ответ:

```json
{
  "data": { ... },
  "meta": { ... } // опционально (пагинация, фильтры)
}
```

#### Ошибка:

```json
{
  "code": "ERROR_CODE",
  "message": "Описание ошибки",
  "details": { ... } // опционально
}
```

### Коды ошибок

#### Аутентификация:

- `INVALID_CREDENTIALS` — неверные учетные данные
- `INVALID_TOKEN` — невалидный токен
- `UNAUTHORIZED` — требуется авторизация

#### Валидация:

- `VALIDATION_ERROR` — ошибка валидации данных
- `AUTH_VALIDATION_ERROR` — ошибка валидации при авторизации

#### Бизнес-логика:

- `APPOINTMENT_CONFLICT` — конфликт времени записи
- `SLOT_NOT_AVAILABLE` — слот недоступен
- `DOCTOR_NOT_AVAILABLE` — врач недоступен
- `PATIENT_NOT_FOUND` — пациент не найден
- `DOCTOR_NOT_FOUND` — врач не найден
- `APPOINTMENT_NOT_FOUND` — запись не найдена

#### Ресурсы:

- `USERNAME_ALREADY_EXISTS` — имя пользователя уже занято
- `ACCOUNT_NOT_FOUND` — учетная запись не найдена

### Пагинация

Все списковые эндпоинты поддерживают пагинацию:

```
GET /resource?page=1&limit=20&sort=created_at&order=desc
```

Ответ:

```json
{
  "data": [...],
  "meta": {
    "page": 1,
    "limit": 20,
    "total": 100,
    "totalPages": 5
  }
}
```

### Фильтрация

Примеры:

```
GET /appointments?doctor_id=1&status=scheduled&date_from=2025-01-01
GET /doctors?specialization_id=2
GET /patients?search=Иванов
```

## Frontend требования

### Дизайн-система

#### Принципы:

- **Минимализм** — чистый интерфейс без лишних элементов
- **Большие кнопки** — удобство для пользователей всех возрастов
- **Типографика** — четкая иерархия, читаемые шрифты
- **Цветовая схема** — использование темы (light/dark mode)
- **Адаптивность** — поддержка мобильных устройств

#### Компоненты (shadcn/ui):

- Button (размеры: sm, md, lg, xl)
- Card
- Input, Textarea
- Select, Combobox
- DatePicker, TimePicker
- Table (с пагинацией и сортировкой)
- Dialog, Sheet
- Toast/Notification
- Badge
- Avatar
- Tabs
- Form (react-hook-form интеграция)

### Основные страницы MVP

#### 1. Авторизация

- Форма входа (username + password)
- Обработка ошибок
- Редирект после успешного входа

#### 2. Дашборд

- Статистика за сегодня (количество приемов, врачей, пациентов)
- Ближайшие приемы
- Быстрые действия

#### 3. Расписание врачей

- Календарь с расписанием
- Фильтр по врачам/специализациям
- Просмотр свободных слотов
- Создание записи на прием

**Ключевой запрос MVP:** "Расписание врача на неделю"

#### 4. Записи на прием

- Список записей (таблица с фильтрами)
- Детали записи
- Создание/редактирование записи
- Отмена записи

#### 5. Пациенты

- Список пациентов (поиск, фильтры)
- Карточка пациента
- История приемов пациента
- История диагнозов

#### 6. Врачи

- Список врачей
- Карточка врача
- Статистика врача
- Управление расписанием врача

#### 7. Прием (детальная страница)

- Информация о приеме
- Жалобы пациента
- Диагнозы
- Назначения (рецепты)
- Завершение приема

### Состояние приложения

#### Управление состоянием:

- **Server State**: React Query для данных с сервера
- **Client State**: Zustand для UI состояния (модалки, фильтры)
- **Form State**: react-hook-form для форм

#### Кэширование:

- React Query кэш для списков и деталей
- Инвалидация кэша при мутациях
- Оптимистичные обновления где возможно

## Технические требования

### Производительность

- Время ответа API < 200ms (p95)
- Первая загрузка страницы < 2s
- Lazy loading для больших списков
- Виртуализация таблиц при > 100 записей

### Безопасность

- HTTPS в production
- Защита от XSS, CSRF
- Валидация всех входных данных
- Rate limiting на API
- Логирование подозрительной активности

### Надежность

- Обработка всех ошибок
- Graceful degradation
- Retry логика для сетевых запросов
- Мониторинг ошибок (Sentry или аналог)

### Тестирование

- Unit тесты для бизнес-логики (Jest)
- Integration тесты для API (Jest + Supertest)
- E2E тесты для критичных сценариев (Playwright)
- Покрытие кода > 70%

## Развертывание

### Окружения

- **Development** — локальная разработка
- **Staging** — тестовое окружение
- **Production** — боевое окружение

### CI/CD

- Автоматические тесты при PR
- Автоматический деплой на staging
- Ручной деплой на production

### Мониторинг

- Логирование (структурированные логи)
- Метрики (response time, error rate)
- Алерты на критические ошибки

## Документация

### API

- Swagger UI (`/docs`)
- ReDoc (`/redoc`)
- Описание всех эндпоинтов
- Примеры запросов/ответов
- Коды ошибок

### Код

- JSDoc комментарии для публичных методов
- README в каждом модуле
- Архитектурные решения (ADR)

## Ограничения MVP

### Не входит в MVP:

- Уведомления (email, SMS)
- Печать документов
- Интеграция с внешними системами
- Мобильное приложение
- Мультитенантность (один инстанс = одна поликлиника)
- Расширенная аналитика
- Экспорт данных

### Входит в MVP:

- Базовый CRUD для всех сущностей
- Запись на прием с проверкой конфликтов
- История болезней пациента
- Выписка рецептов
- Статистика врачей
- Поиск свободных окон

## Приоритеты разработки

### Фаза 1 (MVP Core):

1. Аутентификация и авторизация
2. Управление пациентами и врачами
3. Базовое расписание (шаблоны)
4. Создание записей на прием

### Фаза 2 (MVP Complete):

5. Завершение приема с диагнозами
6. Выписка рецептов
7. История болезней
8. Статистика и отчеты

### Фаза 3 (Polish):

9. Улучшение UX
10. Оптимизация производительности
11. Расширенное тестирование
12. Документация

---

**Версия документа**: 1.0  
**Дата создания**: 2025-01-15  
**Статус**: MVP Planning
